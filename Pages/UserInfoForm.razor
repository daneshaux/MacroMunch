@page "/userinfo"
@using MacroMunch
@using MacroMunch.Models
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@using System.Globalization
@inject MacroMunch.Services.ApiService ApiService


<div class="header-bar">
    <span class="back-arrow" @onclick="GoBack">‚Üê</span>
    <h3 class="h5 header-title">Finish signing up</h3>
</div>

<div class="screen-container">
<div class="form-wrapper user-info-form">
    <!-- Name -->
    <div class="field-group">
        <div class="body-text field-label">Name</div>
        <input class="email-input" placeholder="First name" @bind="firstName" />
        <div style="height: 4px;"></div>
        <input class="email-input" placeholder="Last name" @bind="lastName" />
    </div>

    <div style="height: 24px;"></div>

    <!-- Date of Birth -->
    <div class="field-group">
        <div class="body-text field-label">Date of Birth</div>
        <div class="dob-row">
            <select class="email-input dob-select" @bind="birthMonth">
                <option value="">MM</option>
                <option value="01">01 - Jan</option>
                <option value="02">02 - Feb</option>
                <option value="03">03 - Mar</option>
                <option value="04">04 - Apr</option>
                <option value="05">05 - May</option>
                <option value="06">06 - Jun</option>
                <option value="07">07 - Jul</option>
                <option value="08">08 - Aug</option>
                <option value="09">09 - Sep</option>
                <option value="10">10 - Oct</option>
                <option value="11">11 - Nov</option>
                <option value="12">12 - Dec</option>
            </select>

            <select class="email-input dob-select" @bind="birthDay">
                <option value="">DD</option>
                @for (int d = 1; d <= 31; d++)
                {
                    <option value="@d.ToString("00")">@d.ToString("00")</option>
                }
            </select>

            <select class="email-input dob-select" @bind="birthYear">
                <option value="">YYYY</option>
                @for (int y = 1940; y <= 2010; y++)
                {
                    <option value="@y">@y</option>
                }
            </select>
        </div>
    </div>

    <div style="height: 24px;"></div>

    <!-- Personal Info: Weight / Height / Activity -->
    <div class="field-group">
        <div class="body-text field-label">Personal Info</div>
        <input class="email-input" placeholder="Weight (lbs)" @bind="weight" />
        <div style="height: 4px;"></div>
        <input class="email-input" placeholder="Height (in)" @bind="height" />
        <div style="height: 16px;"></div>

        <div class="body-text field-label" style="margin-bottom: 4px;">Activity Level</div>
        <select class="email-input" @bind="activityLevel">
            <option value="">Select Activity Level</option>
            <option value="sedentary">Sedentary (little to no exercise)</option>
            <option value="lightly_active">Lightly active (1-3 days/week)</option>
            <option value="moderately_active">Moderately active (3-5 days/week)</option>
            <option value="very_active">Very active (6-7 days/week)</option>
        </select>
    </div>

    <div style="height: 24px;"></div>

    <!-- Sex -->
    <div class="field-group">
        <div class="body-text field-label">Sex</div>
        <div class="segmented-control">
            <button type="button"
                    class="segmented-button @(sex == "female" ? "selected" : "")"
                    @onclick="SetSexFemale">
                Female
            </button>
            <button type="button"
                    class="segmented-button @(sex == "male" ? "selected" : "")"
                    @onclick="SetSexMale">
                Male
            </button>
        </div>
    </div>

    <div style="height: 24px;"></div>

    <!-- Account Info -->
    <div class="field-group">
        <div class="body-text field-label">Account Info</div>

        <input class="email-input" placeholder="Email address" @bind="email" />
        <div style="height: 4px;"></div>

        <div class="password-wrapper">
            <input class="email-input password-input"
                placeholder="Password"
                type="@passwordType"
                @bind="password" />
            <button type="button" class="toggle-password" @onclick="TogglePassword">
                @(passwordType == "password" ? "üëÅÔ∏è" : "üôà")
            </button>
        </div>

        <div style="height: 4px;"></div>

        <div class="password-wrapper">
            <input class="email-input password-input"
                placeholder="Confirm password"
                type="@passwordType"
                @bind="confirmPassword" />
            <button type="button" class="toggle-password" @onclick="TogglePassword">
                @(passwordType == "password" ? "üëÅÔ∏è" : "üôà")
            </button>
        </div>
    </div>

    <div style="height: 24px;"></div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">@errorMessage</div>
    }

    <div style="height: 40px;"></div>

    <button class="primary-btn" @onclick="SaveUserInfoAndContinue">
        Continue
    </button>
    </div>
</div>

@code {
    private string firstName = "";
    private string lastName = "";
    private string birthDay = "";
    private string birthMonth = "";
    private string birthYear = "";
    private string birthday = ""; // combined MM/DD/YYYY for saving
    private string weight = "";
    private string height = "";
    private string email = "";
    private string password = "";
    private string confirmPassword = "";
    private string activityLevel = ""; // now: "sedentary", "lightly_active", etc.
    private string passwordType = "password";
    private string errorMessage = "";
    private string sex = "female";  // default

    private void SetSexFemale() => sex = "female";
    private void SetSexMale() => sex = "male";

    protected override async Task OnInitializedAsync()
    {
        // Auto-fill email if present in localStorage
        var storedEmail = await JS.InvokeAsync<string>("localStorage.getItem", "userEmail");
        if (!string.IsNullOrEmpty(storedEmail))
        {
            email = storedEmail;
        }
    }

    private void TogglePassword()
    {
        passwordType = passwordType == "password" ? "text" : "password";
    }

    private async Task SaveUserInfoAndContinue()
    {
        // 1Ô∏è‚É£ Required fields
        if (string.IsNullOrWhiteSpace(firstName) ||
            string.IsNullOrWhiteSpace(lastName)  ||
            string.IsNullOrWhiteSpace(birthDay)  ||
            string.IsNullOrWhiteSpace(birthMonth)||
            string.IsNullOrWhiteSpace(birthYear) ||
            string.IsNullOrWhiteSpace(weight)    ||
            string.IsNullOrWhiteSpace(height)    ||
            string.IsNullOrWhiteSpace(activityLevel) ||
            string.IsNullOrWhiteSpace(email)     ||
            string.IsNullOrWhiteSpace(password)  ||
            string.IsNullOrWhiteSpace(confirmPassword))
        {
            errorMessage = "All fields are required!";
            return;
        }

        // 2Ô∏è‚É£ Weight + height must be numeric
        if (!double.TryParse(weight, NumberStyles.Float, CultureInfo.InvariantCulture, out double parsedWeight) ||
            !double.TryParse(height, NumberStyles.Float, CultureInfo.InvariantCulture, out double parsedHeight))
        {
            errorMessage = "Weight and height must be numbers!";
            return;
        }

        // 3Ô∏è‚É£ Activity level must be selected (but it‚Äôs already a string like 'moderately_active')
        if (string.IsNullOrWhiteSpace(activityLevel))
        {
            errorMessage = "Please select an activity level.";
            return;
        }

        // 4Ô∏è‚É£ Password rules
        if (password.Length < 6)
        {
            errorMessage = "Password must be at least 6 characters.";
            return;
        }

        if (password != confirmPassword)
        {
            errorMessage = "Passwords must match.";
            return;
        }

        // 5Ô∏è‚É£ Build birthday + age
        birthday = $"{birthMonth}/{birthDay}/{birthYear}";

        int year  = int.Parse(birthYear);
        int month = int.Parse(birthMonth);
        int day   = int.Parse(birthDay);

        var dob   = new DateTime(year, month, day);
        var today = DateTime.UtcNow.Date;

        int ageYears = today.Year - dob.Year;
        if (dob.Date > today.AddYears(-ageYears)) ageYears--;

        // 6Ô∏è‚É£ Convert to backend units (kg / cm)
        double heightCm = parsedHeight * 2.54;         // inches ‚Üí cm
        double weightKg = parsedWeight * 0.45359237;   // lbs ‚Üí kg

        // 7Ô∏è‚É£ Activity level is already in API form ("sedentary", "lightly_active", etc.)
        string apiActivityLevel = activityLevel;

        // 8Ô∏è‚É£ Pull goal from GoalSelection (via localStorage)
        var goalFromStorage = await JS.InvokeAsync<string>("localStorage.getItem", "userGoal");
        var apiGoal = string.IsNullOrWhiteSpace(goalFromStorage) ? "maintain" : goalFromStorage;

        // 9Ô∏è‚É£ Build CreateUserRequest for Vishesh‚Äôs API
        var createReq = new CreateUserRequest
        {
            FirstName     = firstName,
            LastName      = lastName,
            Sex           = sex,            // "female" or "male"
            Age           = ageYears,
            Height        = heightCm,
            Weight        = weightKg,
            ActivityLevel = apiActivityLevel,
            Goal          = apiGoal,        // "lose" | "maintain" | "gain"
            DietaryFlags  = new List<string> { "none" },
            MealsPerDay   = 3
        };

        // üîë 10Ô∏è‚É£ Get the Supabase JWT from localStorage
        var jwtToken = await JS.InvokeAsync<string>("localStorage.getItem", "supabaseJwt");

        if (!string.IsNullOrWhiteSpace(jwtToken))
        {
            Console.WriteLine("üß™ Sending CreateUser payload to API...");
            Console.WriteLine(System.Text.Json.JsonSerializer.Serialize(createReq));

            var result = await ApiService.CreateUserAsync(createReq, jwtToken);

            if (result == null)
            {
                Console.WriteLine("CreateUserAsync returned null (might be validation or 409 conflict).");
            }
            else
            {
                Console.WriteLine($"‚úÖ User created/updated on backend with id: {result.User.Id}");
            }
        }
        else
        {
            Console.WriteLine("No Supabase JWT found; skipping backend user create.");
        }

        // üíæ 11Ô∏è‚É£ Local-only stuff (for your UI)
        await JS.InvokeVoidAsync("localStorage.setItem", "userFirstName", firstName);
        await JS.InvokeVoidAsync("localStorage.setItem", "userLastName",  lastName);
        await JS.InvokeVoidAsync("localStorage.setItem", "userOnboardingCompleted", "true");

        // üöÄ 12Ô∏è‚É£ Go to home
        NavigationManager.NavigateTo("/home");
    }

    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }
}

<style>
    select.email-input {
        appearance: none;
        -webkit-appearance: none;
        padding-right: 24px;
        background: url('data:image/svg+xml;utf8,<svg fill="%23B0B0B0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
        background-size: 16px;
    }

    .error-message {
        color: #FF6B6B;
        font-size: 14px;
        margin-top: 12px;
    }

    .field-label {
        color: #4ADE80;
        margin-bottom: 8px;
        display: block;
    }

    .field-group {
        width: 100%;
    }

    .dob-row {
    display: flex;
    gap: 8px;
    width: 100%;
    }

    .dob-select {
        flex: 1 1 0;
        padding-right: 24px;
        box-sizing: border-box;
    }

    .segmented-control {
    display: flex;
    gap: 8px;
    }

    .segmented-option {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1.5px solid #B0B0B0;
        background-color: #0F0F0F;
        color: #F2F2F2;
        font-size: 14px;
        text-align: center;
    }

    .segmented-option.selected {
        border-color: #4ADE80;
        background-color: rgba(74, 222, 128, 0.12);
    }

</style>