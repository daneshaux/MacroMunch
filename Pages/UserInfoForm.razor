@page "/userinfo"
@using MacroMunch
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<div class="header-bar">
    <span class="back-arrow" @onclick="GoBack">‚Üê</span>
    <h3 class="h5 header-title">Finish signing up</h3>
</div>

<div class="form-wrapper user-info-form">
    <input class="email-input" placeholder="First name" @bind="firstName" />
    <div style="height: 4px;"></div>
    <input class="email-input" placeholder="Last name" @bind="lastName" />
    <div style="height: 24px;"></div>

    <input class="email-input" placeholder="Birthday (MM/DD/YYYY)" @bind="birthday" />
    <div style="height: 24px;"></div>

    <input class="email-input" placeholder="Weight (lbs)" @bind="weight" />
    <div style="height: 4px;"></div>
    <input class="email-input" placeholder="Height (in)" @bind="height" />
    <div style="height: 24px;"></div>

    <select class="email-input" style="margin-top: 40px;" @bind="activityLevel">
        <option value="">Select Activity Level</option>
        <option value="1.2">Sedentary (little to no exercise)</option>
        <option value="1.375">Lightly active (1-3 days/week)</option>
        <option value="1.55">Moderately active (3-5 days/week)</option>
        <option value="1.725">Very active (6-7 days/week)</option>
        <option value="1.9">Extra active (very hard exercise/physical job)</option>
    </select>
    <div style="height: 24px;"></div>

    <input class="email-input" placeholder="Email address" @bind="email" />
    <div style="height: 24px;"></div>

    <div class="password-wrapper">
        <input class="email-input password-input" placeholder="Password" type="@passwordType" @bind="password" />
        <button type="button" class="toggle-password" @onclick="TogglePassword">
            @(passwordType == "password" ? "üëÅÔ∏è" : "üôà")
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">@errorMessage</div>
    }

    <div style="height: 40px;"></div>

    <button class="primary-btn" @onclick="SaveUserInfoAndContinue">
        Continue
    </button>
</div>

@code {
    private string firstName = "";
    private string lastName = "";
    private string birthday = "";
    private string weight = "";
    private string height = "";
    private string email = "";
    private string password = "";
    private string activityLevel = "";
    private string passwordType = "password";
    private string userId = "testUserId"; // Replace with real user ID
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        // Auto-fill email if present in localStorage
        var storedEmail = await JS.InvokeAsync<string>("localStorage.getItem", "userEmail");
        if (!string.IsNullOrEmpty(storedEmail))
        {
            email = storedEmail;
        }
    }

    private void TogglePassword()
    {
        passwordType = passwordType == "password" ? "text" : "password";
    }

    private async Task SaveUserInfoAndContinue()
    {
        // Validation logic
        if (string.IsNullOrWhiteSpace(firstName) || string.IsNullOrWhiteSpace(lastName) || string.IsNullOrWhiteSpace(birthday) ||
            string.IsNullOrWhiteSpace(weight) || string.IsNullOrWhiteSpace(height) || string.IsNullOrWhiteSpace(activityLevel) ||
            string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "All fields are required!";
            return;
        }

        if (!double.TryParse(weight, out double parsedWeight) ||
            !double.TryParse(height, out double parsedHeight) ||
            !double.TryParse(activityLevel, out double parsedActivityLevel))
        {
            errorMessage = "Weight, height, and activity level must be numbers!";
            return;
        }

        if (password.Length < 6)
        {
            errorMessage = "Password must be at least 6 characters.";
            return;
        }

        // Clear error if all good
        errorMessage = "";

        // Save to Firebase
        await JS.InvokeVoidAsync(
            "firebaseInterop.saveUserInfo",
            userId,
            firstName,
            lastName,
            birthday,
            weight,
            height,
            email,
            password
        );
        Console.WriteLine("User info submitted and saved to Firebase!");

        // Calculate macros
        var macros = MacroCalculator.CalculateMacros(
            weight: parsedWeight,
            height: parsedHeight,
            activityLevel: parsedActivityLevel
        );

        await JS.InvokeVoidAsync(
            "firebaseInterop.saveManualMacros",
            userId,
            new { protein = macros.Protein, carbs = macros.Carbs, fat = macros.Fat }
        );
        Console.WriteLine("Macros calculated and saved to Firebase!");

        // üíæ Save first and last name to localStorage
        await JS.InvokeVoidAsync("localStorage.setItem", "userFirstName", firstName);
        await JS.InvokeVoidAsync("localStorage.setItem", "userLastName", lastName);

        // Continue
        NavigationManager.NavigateTo("/home");
    }

        // Go Back
        private async Task GoBack()
        {
            await JS.InvokeVoidAsync("history.back");
        }
}

<style>
    select.email-input {
        appearance: none;
        -webkit-appearance: none;
        padding-right: 24px;
        background: url('data:image/svg+xml;utf8,<svg fill="%23B0B0B0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
        background-size: 16px;
    }
    .error-message {
        color: #FF6B6B;
        font-size: 14px;
        margin-top: 12px;
    }
</style>