@page "/setup"
@using MacroMunch.Services

<div class="header-bar">
    <span class="back-arrow" @onclick="GoBack">←</span>
    <h3 class="h5 header-title">Finish signing up</h3>
</div>

<div class="screen-container">
<div class="goal-selection-container">
    <h2 class="h2">What’s your goal?</h2>

    <div class="goal-options">
        <button class="goal-btn @GetButtonClass("lose")"
            @onclick="@(() => SelectGoal("lose"))">
        Lose weight
    </button>

    <button class="goal-btn @GetButtonClass("maintain")"
            @onclick="@(() => SelectGoal("maintain"))">
        Maintain
    </button>

    <button class="goal-btn @GetButtonClass("gain")"
            @onclick="@(() => SelectGoal("gain"))">
        Gain muscle
    </button>
    </div>

    <a class="manual-link" href="/manual-entry">Manually enter my macros</a>
</div>
</div>

@code {
    private string? selectedGoal;

    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private NavigationManager? NavigationManager { get; set; }
    [Inject] private MacroMunch.Services.ApiService ApiService { get; set; } = default!;

    private async Task SelectGoal(string goal)
    {
        selectedGoal = goal;
        StateHasChanged(); // show pressed state

        // 1️⃣ Save locally (used by UserInfoForm and for fallback)
        await JS.InvokeVoidAsync("localStorage.setItem", "userGoal", goal);

        // 2️⃣ Try updating on backend immediately
        var jwt = await JS.InvokeAsync<string>("localStorage.getItem", "supabaseJwt");

        if (!string.IsNullOrWhiteSpace(jwt))
        {
            try
            {
                var success = await ApiService.UpdateUserGoalAsync(jwt, goal);
                if (success)
                {
                    Console.WriteLine($"✅ Updated backend goal to '{goal}'");
                }
                else
                {
                    Console.WriteLine($"⚠️ Backend goal update failed for '{goal}'");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Error updating goal: {ex.Message}");
            }
        }
        else
        {
            Console.WriteLine("⚠️ No JWT found in localStorage, skipping backend goal update");
        }

        // 3️⃣ Tiny delay so the selected button shows visually
        await Task.Delay(300);

        // 4️⃣ Move to dietary preferences
        NavigationManager!.NavigateTo("/dietary-preferences");
    }

    string GetButtonClass(string goal)
    {
        return selectedGoal == goal ? "goal-btn selected" : "goal-btn";
    }

    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }
}
