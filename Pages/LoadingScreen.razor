@page "/loading"
@using System.Text.Json
@using System.Linq
@using MacroMunch.Models
@using MacroMunch.Services

<div class="header-bar">
    <span class="back-arrow" @onclick="GoBack">‚Üê</span>
    <h3 class="h5 header-title">Finish signing up</h3>
</div>

<div class="goal-selection-container">
    <div class="loading-wrapper">
        <div class="dot-loader">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>

        <h2 class="h3" style="margin-top: 40px; text-align: center;">
            Hold tight! We‚Äôre portioning this <em>just</em> for you
        </h2>
    </div>
</div>

@code {
    [Inject] private NavigationManager? NavigationManager { get; set; }
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private ApiService ApiService { get; set; } = default!;

    // üëá This class matches Home.Meal properties so JSON deserialization works there
    private class MealForStorage
    {
        public string Type { get; set; } = "";
        public string ImageUrl { get; set; } = "";
        public string Name { get; set; } = "";
        public int Calories { get; set; }
        public int Protein { get; set; }
        public int Carbs { get; set; }
        public int Fat { get; set; }

        public List<string> Ingredients { get; set; } = new();
        public List<string> DietaryTags { get; set; } = new();
        public List<string> StyleTags { get; set; } = new();
        public string? SpiceLevel { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (!firstRender) return;

    try
    {
        // 1Ô∏è‚É£ Get Supabase JWT
        var jwtToken = await JS.InvokeAsync<string>("localStorage.getItem", "supabaseJwt");
        if (string.IsNullOrWhiteSpace(jwtToken))
        {
            Console.WriteLine("‚ö†Ô∏è No Supabase JWT found, skipping backend meal plan.");
        }
        else
        {
            // 2Ô∏è‚É£ Get macros from backend
            var macroResult = await ApiService.CalculateMacrosAsync(jwtToken);
            if (macroResult != null && macroResult.Meal_Macros.Any())
            {
                Console.WriteLine("‚úÖ Got macros, calling /meals/plan...");

                // 3Ô∏è‚É£ Build request for /meals/plan
                var request = new MealPlanRequest
                {
                    Meal_Macros = macroResult.Meal_Macros
                };

                var planResponse = await ApiService.GenerateMealPlanAsync(request, jwtToken);

                if (planResponse != null && planResponse.Meal_Plans.Any())
                {
                    Console.WriteLine("‚úÖ Got meal plan from backend, flattening to UI meals...");

                    var uiMeals = new List<MealForStorage>();

                    // üåé Demo Alberta names for the FIRST 3 meals
                    var demoNames = new[]
                    {
                        "Hearty Bison Chili",
                        "Maple Veggie Power Bowl",
                        "Cedar Plank Salmon"
                    };

                    // üñºÔ∏è Map demo names ‚Üí images
                    var imageMap = new Dictionary<string, string>
                    {
                        { "Hearty Bison Chili",       "images/recipes/bison-chili.webp" },
                        { "Maple Veggie Power Bowl",  "images/recipes/maple-veggie-bowl.webp" },
                        { "Cedar Plank Salmon",       "images/recipes/salmon-bowl.webp" }
                    };

                    // üçΩÔ∏è Optional: pretty demo ingredients JUST for those 3
                    var ingredientMap = new Dictionary<string, List<string>>
                    {
                        {
                            "Hearty Bison Chili",
                            new List<string>
                            {
                                "150g ground bison",
                                "80g kidney beans",
                                "60g tomato sauce",
                                "30g onion",
                                "Spices & herbs"
                            }
                        },
                        {
                            "Maple Veggie Power Bowl",
                            new List<string>
                            {
                                "100g roasted root vegetables",
                                "80g quinoa",
                                "15g maple maple glaze",
                                "10g pumpkin seeds",
                                "Fresh greens"
                            }
                        },
                        {
                            "Cedar Plank Salmon",
                            new List<string>
                            {
                                "140g wild salmon",
                                "80g roasted potatoes",
                                "60g seasonal vegetables",
                                "Lemon & herb rub"
                            }
                        }
                    };

                    var index = 0;

                    foreach (var mp in planResponse.Meal_Plans)
                    {
                        var firstRecipe = mp.Recipes.FirstOrDefault();

                        // ‚úÖ Diet tags from backend
                        var dietTags = firstRecipe?.Diet_Tags ?? new List<string>();

                        // ‚úÖ Simple style tags
                        var styleTags = new List<string>();
                        if (mp.Actual_Macros.Protein >= 40)
                            styleTags.Add("High Protein");
                        else
                            styleTags.Add("Balanced");

                        if (!string.IsNullOrWhiteSpace(firstRecipe?.Category))
                            styleTags.Add(firstRecipe.Category);

                        // üëá Alberta demo name for first 3 meals; fallback to backend name for others
                        var displayName = index < demoNames.Length
                            ? demoNames[index++]
                            : mp.Meal_Name;

                        // üëá Choose image based on demo name, else placeholder
                        var imageUrl = imageMap.TryGetValue(displayName, out var mappedUrl)
                            ? mappedUrl
                            : "images/food-placeholder.png";

                        // üëá Ingredients: use demo ones if we have them, else real backend ingredients
                        List<string> ingredients;
                        if (ingredientMap.TryGetValue(displayName, out var demoIngredients))
                        {
                            ingredients = demoIngredients;
                        }
                        else
                        {
                            ingredients = firstRecipe?.Ingredients
                                ?.Select(i => $"{i.Grams:N0}g {i.Ingredient_Name}")
                                .ToList()
                                ?? new List<string>();
                        }

                        uiMeals.Add(new MealForStorage
                        {
                            Type        = $"Meal {mp.Meal_Number}",
                            Name        = displayName,
                            ImageUrl    = imageUrl,
                            Calories    = mp.Actual_Macros.Calories,
                            Protein     = (int)Math.Round(mp.Actual_Macros.Protein),
                            Carbs       = (int)Math.Round(mp.Actual_Macros.Carbs),
                            Fat         = (int)Math.Round(mp.Actual_Macros.Fat),
                            DietaryTags = dietTags,
                            StyleTags   = styleTags,
                            SpiceLevel  = "Mild",
                            Ingredients = ingredients
                        });
                    }

                    var json = System.Text.Json.JsonSerializer.Serialize(uiMeals);
                    await JS.InvokeVoidAsync("localStorage.setItem", "mealPlan", json);

                    Console.WriteLine("üçΩÔ∏è Saved Go-generated meal plan to localStorage['mealPlan']");
                }
            }
        }

        // ‚úÖ Mark dietary onboarding done + go home
        await JS.InvokeVoidAsync("localStorage.setItem", "dietOnboardingCompleted", "true");
        NavigationManager!.NavigateTo("/home");
    }
    catch (Exception ex)
    {
        Console.WriteLine("‚ùå Error in LoadingScreen: " + ex.Message);

        // fail-safe: still mark onboarding done and move on
        await JS.InvokeVoidAsync("localStorage.setItem", "dietOnboardingCompleted", "true");
        NavigationManager!.NavigateTo("/home");
    }
}

    private void GoBack()
    {
        NavigationManager!.NavigateTo("/flavor-profiles");
    }
}

<style>
    .dot-loader {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 80px;
    }

    .dot {
        width: 16px;
        height: 16px;
        background-color: #4ADE80;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    .dot:nth-child(3) {
        animation-delay: 0s;
    }

    @@keyframes bounce {
        0%, 80%, 100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1);
        }
    }
</style>