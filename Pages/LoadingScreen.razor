@page "/loading"
@using System.Text.Json
@using System.Linq
@using MacroMunch.Models
@using MacroMunch.Services

<div class="header-bar">
    <span class="back-arrow" @onclick="GoBack">‚Üê</span>
    <h3 class="h5 header-title">Finish signing up</h3>
</div>

<div class="goal-selection-container">
    <div class="loading-wrapper">
        <div class="dot-loader">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>

        <h2 class="h3" style="margin-top: 40px; text-align: center;">
            Hold tight! We‚Äôre portioning this <em>just</em> for you
        </h2>
    </div>
</div>

@code {
    [Inject] private NavigationManager? NavigationManager { get; set; }
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private ApiService ApiService { get; set; } = default!;

    // üëá This class matches Home.Meal properties so JSON deserialization works there
    private class MealForStorage
    {
        public string Type { get; set; } = "";
        public string ImageUrl { get; set; } = "";
        public string Name { get; set; } = "";
        public int Calories { get; set; }
        public int Protein { get; set; }
        public int Carbs { get; set; }
        public int Fat { get; set; }

        public List<string> Ingredients { get; set; } = new();
        public List<string> DietaryTags { get; set; } = new();
        public List<string> StyleTags { get; set; } = new();
        public string? SpiceLevel { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // 1Ô∏è‚É£ Get Supabase JWT
            var jwtToken = await JS.InvokeAsync<string>("localStorage.getItem", "supabaseJwt");
            if (string.IsNullOrWhiteSpace(jwtToken))
            {
                Console.WriteLine("‚ö†Ô∏è No Supabase JWT found, skipping backend meal plan.");
            }
            else
            {
                // 2Ô∏è‚É£ Get macros from backend
                var macroResult = await ApiService.CalculateMacrosAsync(jwtToken);
                if (macroResult != null && macroResult.Meal_Macros.Any())
                {
                    Console.WriteLine("‚úÖ Got macros, calling /meals/plan...");

                    // 3Ô∏è‚É£ Build request for Vishesh's /plan endpoint
                    var request = new MealPlanRequest
                    {
                        Meal_Macros = macroResult.Meal_Macros
                    };

                    var planResponse = await ApiService.GenerateMealPlanAsync(request, jwtToken);

                    if (planResponse != null && planResponse.Meal_Plans.Any())
                    {
                        Console.WriteLine("‚úÖ Got meal plan from backend, flattening to UI meals...");

                        var uiMeals = new List<MealForStorage>();

                        foreach (var mp in planResponse.Meal_Plans)
                        {
                            var firstRecipe = mp.Recipes.FirstOrDefault();

                            // ‚úÖ All diet tags coming from backend
                            var dietTags = firstRecipe?.Diet_Tags ?? new List<string>();

                            // ‚úÖ Build style tags dynamically
                            var styleTags = new List<string>();

                            // Simple rule: only call it "High Protein" if it‚Äôs really high
                            if (mp.Actual_Macros.Protein >= 40)
                            {
                                styleTags.Add("High Protein");
                            }
                            else
                            {
                                styleTags.Add("Balanced");
                            }

                            // Also add the recipe category if backend has one
                            if (!string.IsNullOrWhiteSpace(firstRecipe?.Category))
                            {
                                styleTags.Add(firstRecipe.Category);
                            }

                            uiMeals.Add(new MealForStorage
                            {
                                Type      = $"Meal {mp.Meal_Number}",
                                Name      = mp.Meal_Name,
                                ImageUrl  = "images/food-placeholder.png",
                                Calories  = mp.Actual_Macros.Calories,
                                Protein   = (int)Math.Round(mp.Actual_Macros.Protein),
                                Carbs     = (int)Math.Round(mp.Actual_Macros.Carbs),
                                Fat       = (int)Math.Round(mp.Actual_Macros.Fat),
                                DietaryTags = dietTags,
                                StyleTags   = styleTags,
                                SpiceLevel  = "Mild",
                                Ingredients = firstRecipe?.Ingredients?
                                    .Select(i => $"{i.Grams:N0}g {i.Ingredient_Name}")
                                    .ToList()
                                    ?? new List<string>()
                            });
                        }

                        // 4Ô∏è‚É£ Save to localStorage in a shape Home can read
                        var json = JsonSerializer.Serialize(uiMeals);
                        await JS.InvokeVoidAsync("localStorage.setItem", "mealPlan", json);

                        Console.WriteLine("üçΩÔ∏è Saved Go-generated meal plan to localStorage['mealPlan']");
                    }
                    else
                    {
                        Console.WriteLine("‚ö†Ô∏è GenerateMealPlanAsync returned null or no meals.");
                    }
                }
                else
                {
                    Console.WriteLine("‚ö†Ô∏è CalculateMacrosAsync returned null or no meal_macros.");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("‚ùå Error generating meal plan via Go API: " + ex.Message);
        }

        // 5Ô∏è‚É£ Flip flag + navigate home after a small UX delay
        await Task.Delay(1000);
        await JS.InvokeVoidAsync("localStorage.setItem", "dietOnboardingCompleted", "true");
        NavigationManager!.NavigateTo("/home");
    }

    private void GoBack()
    {
        NavigationManager!.NavigateTo("/flavor-profiles");
    }
}

<style>
    .dot-loader {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 80px;
    }

    .dot {
        width: 16px;
        height: 16px;
        background-color: #4ADE80;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    .dot:nth-child(3) {
        animation-delay: 0s;
    }

    @@keyframes bounce {
        0%, 80%, 100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1);
        }
    }
</style>