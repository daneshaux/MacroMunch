@page "/"
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<div class="welcome-container">
    <img src="images/logo.png" alt="MacroMunch logo" class="logo" />

    <p class="caption">Delicious macro-friendly meals, made for <em>you</em>.</p>

    <div class="screen-container">
    <div class="form-wrapper">
        <h3 class="h3">Log in or sign up</h3>

        <input class="email-input" placeholder="Enter your email" @bind="email" />

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">@errorMessage</div>
        }

        @if (showPassword)
        {
            <div style="height: 16px;"></div>

            <input class="email-input"
                   placeholder="Enter your password"
                   type="password"
                   @bind="password" />

            <div style="height: 16px;"></div>

            <button class="primary-btn" @onclick="SignInUser">
                Sign in
            </button>

            <button class="secondary-btn" style="margin-top: 8px;" @onclick="ResetEmail">
                Use a different email
            </button>
        }
        else
        {
            <div style="height: 16px;"></div>

            <button class="primary-btn" @onclick="SaveEmailAndContinue">
                Continue
            </button>

            <div class="divider">or</div>

            <button class="secondary-btn">
                <i class="fab fa-google"></i> Continue with Google
            </button>

            <button class="secondary-btn">
                <i class="fab fa-apple"></i> Continue with Apple
            </button>

            <button class="secondary-btn">
                <i class="fab fa-facebook-f"></i> Continue with Facebook
            </button>
        }
    </div>
</div>
</div>

@code {
    private string email = "";
    private string password = "";
    private string errorMessage = "";
    private bool showPassword = false;

    private async Task SaveEmailAndContinue()
    {
        errorMessage = "";

        if (string.IsNullOrWhiteSpace(email))
        {
            errorMessage = "Email is required.";
            return;
        }

        // Save email for later (UserInfo, etc.)
        await JS.InvokeVoidAsync("localStorage.setItem", "userEmail", email);

        // Reveal password field + sign-in button
        showPassword = true;
    }

    private async Task SignInUser()
    {
        errorMessage = "";

        if (string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "Please enter your password.";
            return;
        }

        try
        {
            var token = await JS.InvokeAsync<string?>(
                "supabaseInterop.signIn",
                email,
                password
            );

            if (string.IsNullOrEmpty(token))
            {
                errorMessage = "Could not sign you in. Please check your email and password.";
                return;
            }

            // 💾 Store JWT + email
            await JS.InvokeVoidAsync("localStorage.setItem", "supabaseJwt", token);
            await JS.InvokeVoidAsync("localStorage.setItem", "userEmail", email);

            // 👀 Check if they've already completed /userinfo before
            var onboardingFlag = await JS.InvokeAsync<string>("localStorage.getItem", "userOnboardingCompleted");

            if (onboardingFlag == "true")
            {
                // Returning user → straight to Home
                NavigationManager.NavigateTo("/home");
            }
            else
            {
                // First time → finish signup info
                NavigationManager.NavigateTo("/userinfo");
            }
        }
        catch (JSException ex)
        {
            Console.WriteLine("Supabase signIn JS error: " + ex.Message);
            errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            Console.WriteLine("Unexpected auth error: " + ex.Message);
            errorMessage = "Something went wrong. Please try again.";
        }
    }

    private void ResetEmail()
    {
        showPassword = false;
        password = "";
        errorMessage = "";
    }
}

<style>
    .or-text {
    text-align: center;
    display: block;
    margin: 0;
    color: #B0B0B0; /* or your caption color */
    font-family: 'Roboto', sans-serif;
    font-size: 16px;
    }

    .divider {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #B0B0B0;
    font-family: 'Roboto', sans-serif;
    font-size: 14px;
    margin: 0 0 24px 0; /* Balanced spacing top and bottom */
    position: relative;
    }

    .divider::before,
    .divider::after {
    content: "";
    flex: 1;
    border-bottom: 1px solid #333;
    margin: 0 12px;
    }
</style>